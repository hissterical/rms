<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Digital Menu</title>
    <link rel="stylesheet" href="/public/css/menu.css">
  </head>
  <body>
    <div class="container">
      <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>Loading menu...</p>
      </div>

      <div id="error-container" style="display: none">
        <div class="error-message">
          <h3>Oops! Something went wrong</h3>
          <p id="error-message"></p>
        </div>
      </div>

      <div id="menu-container" style="display: none">
        <div class="restaurant-header">
          <button class="translate-button" id="translate-btn">
            ğŸŒ Translate
          </button>
          <div class="translate-dropdown" id="translate-dropdown">
            <div class="language-option" data-lang="en">ğŸ‡ºğŸ‡¸ English</div>
            <div class="language-option" data-lang="es">ğŸ‡ªğŸ‡¸ Spanish</div>
            <div class="language-option" data-lang="fr">ğŸ‡«ğŸ‡· French</div>
            <div class="language-option" data-lang="de">ğŸ‡©ğŸ‡ª German</div>
            <div class="language-option" data-lang="it">ğŸ‡®ğŸ‡¹ Italian</div>
            <div class="language-option" data-lang="pt">ğŸ‡µğŸ‡¹ Portuguese</div>
            <div class="language-option" data-lang="ru">ğŸ‡·ğŸ‡º Russian</div>
            <div class="language-option" data-lang="ja">ğŸ‡¯ğŸ‡µ Japanese</div>
            <div class="language-option" data-lang="ko">ğŸ‡°ğŸ‡· Korean</div>
            <div class="language-option" data-lang="zh">ğŸ‡¨ğŸ‡³ Chinese</div>
            <div class="language-option" data-lang="hi">ğŸ‡®ğŸ‡³ Hindi</div>
            <div class="language-option" data-lang="ar">ğŸ‡¸ğŸ‡¦ Arabic</div>
          </div>

          <h1 class="restaurant-name" id="restaurant-name"></h1>
          <div class="restaurant-info">
            <p id="restaurant-address"></p>
          </div>
        </div>

        <div class="table-info">
          <p>
            You are viewing the menu for Table <span id="table-number"></span>
          </p>
        </div>

        <div id="menu-content"></div>

        <div id="no-menu" class="no-menu" style="display: none">
          <h3>Menu Coming Soon</h3>
          <p>
            This restaurant hasn't added any menu items yet. Please check back
            later!
          </p>
        </div>
      </div>
    </div>

    <!-- Floating Cart Icon -->
    <button class="cart-icon" id="cart-icon" style="display: none">
      ğŸ›’
      <span class="cart-badge" id="cart-badge">0</span>
    </button>

    <!-- Cart Modal -->
    <div class="cart-modal" id="cart-modal">
      <div class="cart-content">
        <div class="cart-header">
          <h2>Your Order</h2>
          <button class="close-cart" id="close-cart">&times;</button>
        </div>

        <div id="cart-items-container">
          <div class="cart-items" id="cart-items">
            <!-- Cart items will be populated here -->
          </div>

          <div class="empty-cart" id="empty-cart">
            <div class="empty-cart-icon">ğŸ›’</div>
            <p>Your cart is empty</p>
            <p>Add some delicious items from the menu!</p>
          </div>

          <div class="cart-summary" id="cart-summary" style="display: none">
            <div class="cart-total">
              <span>Total:</span>
              <span id="cart-total">$0.00</span>
            </div>

            <input
              type="text"
              class="customer-name"
              id="customer-name"
              placeholder="Your name (optional)"
            />

            <textarea
              class="special-instructions"
              id="special-instructions"
              placeholder="Special instructions (e.g., no onions, extra spicy, etc.)"
            ></textarea>

            <button class="checkout-btn" id="checkout-btn">Place Order</button>
          </div>

          <div class="success-message" id="order-success" style="display: none">
            <h3>ğŸ‰ Order Placed Successfully!</h3>
            <p>
              Your order has been sent to the kitchen. We'll prepare it shortly!
            </p>
            <p>
              <strong>Order Total: <span id="success-total"></span></strong>
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Get restaurant ID and table number from URL path
      const pathParts = window.location.pathname.split("/");
      const restaurantId = pathParts[2];
      const tableNumber = pathParts[3];
      let currentLanguage = "en";
      let originalTexts = {}; // Store original texts for translation
      let cart = []; // Store cart items
      let restaurantData = {}; // Store restaurant data for orders

      // Translation functionality
      const translateButton = document.getElementById("translate-btn");
      const translateDropdown = document.getElementById("translate-dropdown");

      translateButton.addEventListener("click", (e) => {
        e.stopPropagation();
        translateDropdown.style.display =
          translateDropdown.style.display === "block" ? "none" : "block";
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", () => {
        translateDropdown.style.display = "none";
      });

      // Language selection
      document.querySelectorAll(".language-option").forEach((option) => {
        option.addEventListener("click", (e) => {
          const targetLang = e.target.getAttribute("data-lang");
          translatePage(targetLang);
          translateDropdown.style.display = "none";
        });
      });

      async function translatePage(targetLang) {
        if (targetLang === currentLanguage) return;

        try {
          // Show loading state
          document.body.classList.add("translating");
          translateButton.textContent = "ğŸ”„ Translating...";

          const elementsToTranslate = [
            ...document.querySelectorAll(".restaurant-name"),
            ...document.querySelectorAll(".restaurant-info p"),
            ...document.querySelectorAll(".table-info p"),
            ...document.querySelectorAll(".category-title"),
            ...document.querySelectorAll(".menu-item-name"),
            ...document.querySelectorAll(".menu-item-description"),
            ...document.querySelectorAll(".no-menu h3"),
            ...document.querySelectorAll(".no-menu p"),
          ];

          // Store original texts if translating for the first time
          if (currentLanguage === "en") {
            elementsToTranslate.forEach((element, index) => {
              originalTexts[index] = element.textContent;
            });
          }

          if (targetLang === "en") {
            // Restore original texts
            elementsToTranslate.forEach((element, index) => {
              if (originalTexts[index]) {
                element.textContent = originalTexts[index];
              }
            });
          } else {
            // Translate texts
            const textsToTranslate = elementsToTranslate.map(
              (el, index) => originalTexts[index] || el.textContent
            );

            const translatedTexts = await translateTexts(
              textsToTranslate,
              targetLang
            );

            elementsToTranslate.forEach((element, index) => {
              if (translatedTexts[index]) {
                element.textContent = translatedTexts[index];
              }
            });
          }

          currentLanguage = targetLang;
          translateButton.textContent = "ğŸŒ Translate";
        } catch (error) {
          console.error("Translation error:", error);
          translateButton.textContent = "âŒ Translation Error";
          setTimeout(() => {
            translateButton.textContent = "ğŸŒ Translate";
          }, 2000);
        } finally {
          document.body.classList.remove("translating");
        }
      }

      async function translateTexts(texts, targetLang) {
        // Using LibreTranslate API (free alternative to Google Translate)
        // You can replace this with Google Translate API if you have an API key
        try {
          const translatedTexts = [];

          for (const text of texts) {
            if (!text.trim()) {
              translatedTexts.push(text);
              continue;
            }

            // Use MyMemory API which is more reliable and doesn't require CORS setup
            const encodedText = encodeURIComponent(text);
            const response = await fetch(
              `https://api.mymemory.translated.net/get?q=${encodedText}&langpair=en|${targetLang}`
            );

            if (response.ok) {
              const result = await response.json();
              if (result.responseStatus === 200) {
                translatedTexts.push(result.responseData.translatedText);
              } else {
                translatedTexts.push(text);
              }
            } else {
              // Fallback: return original text if translation fails
              translatedTexts.push(text);
            }

            // Small delay to avoid rate limiting
            await new Promise((resolve) => setTimeout(resolve, 300));
          }

          return translatedTexts;
        } catch (error) {
          console.error("Translation service error:", error);
          // Return original texts as fallback
          return texts;
        }
      }

      // Cart functionality
      function initializeCart() {
        const cartIcon = document.getElementById("cart-icon");
        const cartModal = document.getElementById("cart-modal");
        const closeCart = document.getElementById("close-cart");
        const checkoutBtn = document.getElementById("checkout-btn");

        // Cart icon click
        cartIcon.addEventListener("click", () => {
          cartModal.style.display = "flex";
          updateCartDisplay();
        });

        // Close cart
        closeCart.addEventListener("click", () => {
          cartModal.style.display = "none";
        });

        // Close cart when clicking outside
        cartModal.addEventListener("click", (e) => {
          if (e.target === cartModal) {
            cartModal.style.display = "none";
          }
        });

        // Checkout button
        checkoutBtn.addEventListener("click", placeOrder);
      }

      function addToCart(item) {
        const existingItem = cart.find((cartItem) => cartItem.id === item.id);

        if (existingItem) {
          existingItem.quantity += 1;
        } else {
          cart.push({
            id: item.id,
            name: item.name,
            price: parseFloat(item.price),
            quantity: 1,
            category: item.category,
          });
        }

        updateCartBadge();
        showCartIcon();

        // Show brief feedback
        const btn = document.querySelector(`[data-item-id="${item.id}"]`);
        if (btn) {
          const originalText = btn.textContent;
          btn.textContent = "Added!";
          btn.style.background = "#27ae60";
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = "#27ae60";
          }, 1000);
        }
      }

      function removeFromCart(itemId) {
        const itemIndex = cart.findIndex((item) => item.id === itemId);
        if (itemIndex > -1) {
          cart.splice(itemIndex, 1);
          updateCartBadge();
          updateCartDisplay();

          if (cart.length === 0) {
            hideCartIcon();
          }
        }
      }

      function updateQuantity(itemId, change) {
        const item = cart.find((cartItem) => cartItem.id === itemId);
        if (item) {
          item.quantity += change;
          if (item.quantity <= 0) {
            removeFromCart(itemId);
          } else {
            updateCartBadge();
            updateCartDisplay();
          }
        }
      }

      function updateCartBadge() {
        const badge = document.getElementById("cart-badge");
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        badge.textContent = totalItems;
      }

      function showCartIcon() {
        const cartIcon = document.getElementById("cart-icon");
        cartIcon.style.display = "flex";
      }

      function hideCartIcon() {
        const cartIcon = document.getElementById("cart-icon");
        cartIcon.style.display = "none";
      }

      function updateCartDisplay() {
        const cartItems = document.getElementById("cart-items");
        const emptyCart = document.getElementById("empty-cart");
        const cartSummary = document.getElementById("cart-summary");
        const cartTotal = document.getElementById("cart-total");

        if (cart.length === 0) {
          cartItems.style.display = "none";
          cartSummary.style.display = "none";
          emptyCart.style.display = "block";
          return;
        }

        emptyCart.style.display = "none";
        cartItems.style.display = "block";
        cartSummary.style.display = "block";

        // Update cart items
        cartItems.innerHTML = cart
          .map(
            (item) => `
          <div class="cart-item">
            <div class="cart-item-info">
              <div class="cart-item-name">${item.name}</div>
              <div class="cart-item-price">$${item.price.toFixed(2)} each</div>
            </div>
            <div class="cart-item-controls">
              <button class="quantity-btn" onclick="updateQuantity('${
                item.id
              }', -1)">-</button>
              <span class="quantity-display">${item.quantity}</span>
              <button class="quantity-btn" onclick="updateQuantity('${
                item.id
              }', 1)">+</button>
              <button class="remove-item" onclick="removeFromCart('${
                item.id
              }')">Remove</button>
            </div>
          </div>
        `
          )
          .join("");

        // Update total
        const total = cart.reduce(
          (sum, item) => sum + item.price * item.quantity,
          0
        );
        cartTotal.textContent = `$${total.toFixed(2)}`;
      }

      async function placeOrder() {
        if (cart.length === 0) return;

        const checkoutBtn = document.getElementById("checkout-btn");
        const customerName =
          document.getElementById("customer-name").value.trim() || "Guest";
        const specialInstructions = document
          .getElementById("special-instructions")
          .value.trim();

        checkoutBtn.disabled = true;
        checkoutBtn.textContent = "Placing Order...";

        try {
          const orderData = {
            restaurant_id: restaurantId,
            table_number: parseInt(tableNumber),
            items: cart.map((item) => ({
              menu_item_id: item.id,
              name: item.name,
              price: item.price,
              quantity: item.quantity,
              category: item.category,
            })),
            special_instructions: specialInstructions,
            total_amount: cart.reduce(
              (sum, item) => sum + item.price * item.quantity,
              0
            ),
            customer_name: customerName,
          };

          const response = await fetch("/api/orders", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(orderData),
          });

          if (response.ok) {
            const result = await response.json();

            // Show success message
            document.getElementById("cart-items-container").style.display =
              "none";
            document.getElementById("order-success").style.display = "block";
            document.getElementById(
              "success-total"
            ).textContent = `$${orderData.total_amount.toFixed(2)}`;

            // Clear cart
            cart = [];
            updateCartBadge();
            hideCartIcon();

            // Reset form
            document.getElementById("customer-name").value = "";
            document.getElementById("special-instructions").value = "";

            // Auto close after 3 seconds
            setTimeout(() => {
              document.getElementById("cart-modal").style.display = "none";
              document.getElementById("order-success").style.display = "none";
              document.getElementById("cart-items-container").style.display =
                "block";
            }, 3000);
          } else {
            throw new Error("Failed to place order");
          }
        } catch (error) {
          console.error("Order error:", error);
          alert("Failed to place order. Please try again.");
        } finally {
          checkoutBtn.disabled = false;
          checkoutBtn.textContent = "Place Order";
        }
      }

      async function loadMenu() {
        try {
          const response = await fetch(
            `/api/menus/${restaurantId}/${tableNumber}`
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          // Store restaurant data for orders
          restaurantData = data.restaurant;

          // Hide loading
          document.getElementById("loading").style.display = "none";

          // Show menu container
          document.getElementById("menu-container").style.display = "block";

          // Initialize cart functionality
          initializeCart();

          // Populate restaurant info
          document.getElementById("restaurant-name").textContent =
            data.restaurant.name;
          document.getElementById("restaurant-address").textContent =
            data.restaurant.address || "";
          document.getElementById("table-number").textContent =
            data.table_number;

          // Check if menu has items
          const menuCategories = Object.keys(data.menu);
          if (menuCategories.length === 0) {
            document.getElementById("no-menu").style.display = "block";
            return;
          }

          // Populate menu
          const menuContent = document.getElementById("menu-content");
          menuContent.innerHTML = "";

          menuCategories.forEach((category) => {
            const items = data.menu[category];
            if (items.length === 0) return;

            const categoryDiv = document.createElement("div");
            categoryDiv.className = "category";

            const categoryTitle = document.createElement("h2");
            categoryTitle.className = "category-title";
            categoryTitle.textContent = category;
            categoryDiv.appendChild(categoryTitle);

            const itemsDiv = document.createElement("div");
            itemsDiv.className = "menu-items";

            items.forEach((item, index) => {
              const itemDiv = document.createElement("div");
              itemDiv.className = "menu-item";

              // Image container (always present, even if no image)
              const imageContainer = document.createElement("div");
              imageContainer.className = "menu-item-image-container";

              if (item.image_url) {
                const img = document.createElement("img");
                img.src = item.image_url;
                img.alt = item.name;
                img.className = "menu-item-image";
                imageContainer.appendChild(img);
              } else {
                const placeholder = document.createElement("div");
                placeholder.className = "no-image-placeholder";
                placeholder.textContent = "ğŸ½ï¸";
                imageContainer.appendChild(placeholder);
              }

              itemDiv.appendChild(imageContainer);

              // Content container
              const contentDiv = document.createElement("div");
              contentDiv.className = "menu-item-content";

              const headerDiv = document.createElement("div");
              headerDiv.className = "menu-item-header";

              const nameElement = document.createElement("h3");
              nameElement.className = "menu-item-name";
              nameElement.textContent = item.name;

              const priceElement = document.createElement("span");
              priceElement.className = "menu-item-price";
              priceElement.textContent = `$${parseFloat(item.price).toFixed(
                2
              )}`;

              headerDiv.appendChild(nameElement);
              headerDiv.appendChild(priceElement);
              contentDiv.appendChild(headerDiv);

              if (item.description) {
                const descElement = document.createElement("p");
                descElement.className = "menu-item-description";

                // Check if description is long (more than 100 characters)
                const isLong = item.description.length > 100;

                if (isLong) {
                  descElement.classList.add("truncated");
                  descElement.textContent = item.description;

                  const showMoreBtn = document.createElement("button");
                  showMoreBtn.className = "show-more-btn";
                  showMoreBtn.textContent = "Show more";

                  showMoreBtn.addEventListener("click", () => {
                    if (descElement.classList.contains("truncated")) {
                      descElement.classList.remove("truncated");
                      descElement.classList.add("expanded");
                      showMoreBtn.textContent = "Show less";
                    } else {
                      descElement.classList.remove("expanded");
                      descElement.classList.add("truncated");
                      showMoreBtn.textContent = "Show more";
                    }
                  });

                  contentDiv.appendChild(descElement);
                  contentDiv.appendChild(showMoreBtn);
                } else {
                  descElement.textContent = item.description;
                  contentDiv.appendChild(descElement);
                }
              }

              // Add to Cart button
              const addToCartBtn = document.createElement("button");
              addToCartBtn.className = "add-to-cart-btn";
              addToCartBtn.textContent = "Add to Cart";
              addToCartBtn.setAttribute("data-item-id", item.id);
              addToCartBtn.addEventListener("click", () => {
                addToCart({
                  id: item.id,
                  name: item.name,
                  price: item.price,
                  category: category,
                });
              });
              contentDiv.appendChild(addToCartBtn);

              itemDiv.appendChild(contentDiv);
              itemsDiv.appendChild(itemDiv);
            });

            categoryDiv.appendChild(itemsDiv);
            menuContent.appendChild(categoryDiv);
          });
        } catch (error) {
          console.error("Error loading menu:", error);
          document.getElementById("loading").style.display = "none";
          document.getElementById("error-container").style.display = "block";
          document.getElementById("error-message").textContent =
            "Failed to load the menu. Please try again later.";
        }
      }

      // Load menu when page loads
      window.addEventListener("load", loadMenu);
    </script>
  </body>
</html>
