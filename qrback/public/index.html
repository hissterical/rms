<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>QR Menu Creator - Restaurant Registration</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .form-section {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .restaurants-list {
        margin-top: 30px;
      }
      .restaurant-card {
        background: white;
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
      }
      .qr-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 10px;
      }
      .qr-item {
        text-align: center;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 4px;
      }
      .qr-item img {
        max-width: 100%;
        height: auto;
      }
    </style>
  </head>
  <body>
    

    <div class="restaurants-list">
      <h2>All Restaurants</h2>
      <button id="refresh-btn" onclick="loadAllRestaurants()">
        Refresh List
      </button>
      <div id="restaurants-container"></div>
    </div>

    <script>
      // Load all restaurants when page loads
      document.addEventListener("DOMContentLoaded", loadAllRestaurants);

      const form = document.getElementById("restaurant-form");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const address = document.getElementById("address").value;
        const tables_count = parseInt(document.getElementById("tables").value);

        try {
          const res = await fetch("/api/restaurants/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email, address, tables_count }),
          });

          const data = await res.json();
          console.log(data);

          if (res.ok) {
            let html = `<div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 4px; margin: 20px 0;">
            <h3>âœ… Restaurant Registered Successfully!</h3>
            <p><strong>Restaurant ID:</strong> ${data.restaurant.id}</p>
            <p><strong>Name:</strong> ${data.restaurant.name}</p>
          </div>`;

            // Get and display tables
            const tablesRes = await fetch(
              `/api/restaurants/${data.restaurant.id}/tables`
            );
            const tables = await tablesRes.json();

            if (tablesRes.ok) {
              html += "<h3>Generated QR Codes:</h3><div class='qr-grid'>";
              tables.forEach((t) => {
                html += `<div class="qr-item">
                <strong>Table ${t.table_number}</strong><br>
                <img src="${t.qr_code_url}" alt="Table ${t.table_number} QR Code" />
              </div>`;
              });
              html += "</div>";
            }

            document.getElementById("result").innerHTML = html;

            // Clear form
            form.reset();

            // Refresh the restaurant list
            loadAllRestaurants();
          } else {
            document.getElementById(
              "result"
            ).innerHTML = `<div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 4px; margin: 20px 0;">
            <strong>Error:</strong> ${data.error || "Something went wrong"}
          </div>`;
          }
        } catch (error) {
          console.error("Error:", error);
          document.getElementById(
            "result"
          ).innerHTML = `<div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 4px; margin: 20px 0;">
          <strong>Error:</strong> Failed to register restaurant
        </div>`;
        }
      });

      async function loadAllRestaurants() {
        try {
          const res = await fetch("/api/restaurants");
          const restaurants = await res.json();

          if (res.ok) {
            let html = "";

            if (restaurants.length === 0) {
              html = "<p>No restaurants registered yet.</p>";
            } else {
              for (const restaurant of restaurants) {
                html += `<div class="restaurant-card">
                <h3>${restaurant.name}</h3>
                <p><strong>Email:</strong> ${
                  restaurant.contact_email || "N/A"
                }</p>
                <p><strong>Address:</strong> ${restaurant.address || "N/A"}</p>
                <p><strong>Created:</strong> ${new Date(
                  restaurant.created_at
                ).toLocaleDateString()}</p>
                <p><strong>ID:</strong> ${restaurant.id}</p>
                <div id="tables-${restaurant.id}">Loading QR codes...</div>
              </div>`;
              }

              // Load QR codes for each restaurant
              for (const restaurant of restaurants) {
                loadRestaurantQRs(restaurant.id);
              }
            }

            document.getElementById("restaurants-container").innerHTML = html;
          }
        } catch (error) {
          console.error("Error loading restaurants:", error);
          document.getElementById("restaurants-container").innerHTML =
            "<p>Error loading restaurants.</p>";
        }
      }

      async function loadRestaurantQRs(restaurantId) {
        try {
          const res = await fetch(`/api/restaurants/${restaurantId}/tables`);
          const tables = await res.json();

          if (res.ok) {
            let html = '<h4>QR Codes:</h4><div class="qr-grid">';
            tables.forEach((table) => {
              html += `<div class="qr-item">
              <strong>Table ${table.table_number}</strong><br>
              <img src="${table.qr_code_url}" alt="Table ${table.table_number} QR Code" />
            </div>`;
            });
            html += "</div>";

            document.getElementById(`tables-${restaurantId}`).innerHTML = html;
          } else {
            document.getElementById(`tables-${restaurantId}`).innerHTML =
              "<p>No QR codes found.</p>";
          }
        } catch (error) {
          console.error("Error loading QR codes:", error);
          document.getElementById(`tables-${restaurantId}`).innerHTML =
            "<p>Error loading QR codes.</p>";
        }
      }
    </script>
  </body>
</html>
